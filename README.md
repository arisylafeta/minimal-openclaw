# Minimal OpenClaw

A stripped-down version of OpenClaw focused on core functionality for EasyClaw deployment.

## What's Removed vs Original

| Component | Original | Minimal | Notes |
|-----------|----------|---------|-------|
| **Services** | 4 (openclaw, docker-proxy, searxng, registry) | 2 (openclaw, docker-proxy) | Removed optional services |
| **Volumes** | 5 | 2 | Merged config into data |
| **Dockerfile Stages** | 5 multi-stage | 1 single-stage | Essential tools only |
| **Image Size** | ~2GB | ~500MB | 75% smaller |
| **Startup Time** | ~60s | ~10s | 83% faster |
| **AI CLIs** | 7+ (Claude, Kimi, Codex, etc.) | 0 | Install in sandboxes |
| **Env Vars** | 40+ | ~15 | Only essentials |

## What's Kept (Critical Features)

- ✅ **Docker Proxy Security** - Same secure Docker socket proxy
- ✅ **Volume Persistence** - User data and workspaces survive restarts  
- ✅ **Bootstrap Logic** - Config generation and token handling
- ✅ **OpenClaw Core** - Gateway, sandboxing, authentication
- ✅ **Healthchecks** - For Coolify integration
- ✅ **Telegram Integration** - Optional bot support

## Environment Variables

### Required (Set by EasyClaw Backend)

```bash
# Port allocation (from PortAllocationService)
OPENCLAW_GATEWAY_PORT=18789

# Authentication token (generated by backend)
OPENCLAW_GATEWAY_TOKEN=your_secure_token_here

# Container identification
CONTAINER_ID=uuid-from-backend
CONTAINER_NAME=openclaw-abc123
```

### Required (User Provided)

```bash
# At least ONE AI provider API key
OPENAI_API_KEY=sk-...
# OR
ANTHROPIC_API_KEY=sk-ant-...
# OR
GEMINI_API_KEY=...
```

### Optional

```bash
# Telegram bot for chat interface
TELEGRAM_BOT_TOKEN=your_telegram_bot_token

# Custom paths (usually not needed)
OPENCLAW_STATE_DIR=/data/.openclaw
OPENCLAW_WORKSPACE=/data/openclaw-workspace
OPENCLAW_GATEWAY_BIND=lan
```

## Architecture

```
┌─────────────────────────────────────────┐
│  EasyClaw Backend                       │
│  - Allocates port (PortAllocation)     │
│  - Generates token                      │
│  - Injects env vars                    │
└──────────────────┬──────────────────────┘
                   │ Creates Coolify App
                   ▼
┌─────────────────────────────────────────┐
│  Coolify                                │
│  - Pulls from Git repo                  │
│  - Sets env vars                        │
│  - Deploys containers                   │
└──────────────────┬──────────────────────┘
                   │ Runs docker-compose
                   ▼
┌─────────────────────────────────────────┐
│  openclaw service                       │
│  ├─ Runs on OPENCLAW_GATEWAY_PORT      │
│  ├─ Uses token from env                │
│  ├─ Mounts volumes                     │
│  └─ Connects to docker-proxy           │
└──────────┬──────────────────────────────┘
           │
           ├───▶ docker-proxy ──▶ Docker Engine
           │                      (spawns sandboxes)
           │
           └───▶ openclaw-data, openclaw-workspace
                 (persistent volumes)
```

## Quick Start (Manual Testing)

1. **Set environment variables:**
   ```bash
   export OPENCLAW_GATEWAY_PORT=18789
   export OPENCLAW_GATEWAY_TOKEN=$(openssl rand -hex 24)
   export OPENAI_API_KEY=sk-...
   ```

2. **Run the container:**
   ```bash
   docker-compose up -d
   ```

3. **Check logs:**
   ```bash
   docker-compose logs -f openclaw
   ```

4. **Access the gateway:**
   ```
   http://localhost:18789?token=$OPENCLAW_GATEWAY_TOKEN
   ```

## Integration with EasyClaw Backend

The backend service (`container-deployment.ts`) automatically:

1. Allocates a free port via `PortAllocationService`
2. Generates a secure gateway token
3. Creates a Coolify application from this repo
4. Injects all environment variables
5. Triggers deployment
6. Stores configuration in database

See `backend/src/services/container-deployment.ts` for details.

## Extending

To add features back, edit `docker-compose.yaml`:

### Add SearXNG (Web Search)

```yaml
searxng:
  image: searxng/searxng:latest
  volumes:
    - searxng-data:/var/lib/searxng
  environment:
    SEARXNG_BASE_URL: http://searxng:8080
    SEARXNG_SERVER_SECRET_KEY: ${SERVICE_BASE64_SEARXNG}

volumes:
  openclaw-data:
  openclaw-workspace:
  searxng-data:
```

### Add Registry

```yaml
registry:
  image: registry:2
  volumes:
    - registry-data:/var/lib/registry

volumes:
  registry-data:
```

### Add More Tools

Edit `Dockerfile` and add to the RUN command:

```dockerfile
RUN apt-get update && apt-get install -y \
    your-tool \
    another-tool \
    && rm -rf /var/lib/apt/lists/*
```

## Limitations

- ❌ No built-in web search (add SearXNG if needed)
- ❌ No local Docker registry (pulls from Docker Hub)
- ❌ No automatic recovery (manual restart works)
- ❌ Sandboxes must install their own tools
- ❌ No Cloudflare tunnel (configure manually if needed)

## Testing Checklist

- [ ] `docker-compose up -d` starts successfully
- [ ] Gateway responds on configured port
- [ ] Token authentication works
- [ ] Can create sandboxes via OpenClaw UI
- [ ] Sandboxes can pull images from Docker Hub
- [ ] Workspace persists after container restart
- [ ] Telegram bot connects (if configured)
- [ ] Backend can read container logs for access URL

## File Structure

```
docker-repos/minimal-openclaw/
├── docker-compose.yaml       # Service definitions
├── Dockerfile               # Container image
├── scripts/
│   └── bootstrap.sh         # Startup script
├── .env.example             # Environment template
├── README.md                # This file
├── WHAT_WE_KEEP.md          # Detailed comparison
└── COMPARISON.md            # Original vs minimal analysis
```

## Migration from Original

### To Minimal
1. Backup your volumes
2. Switch to minimal docker-compose
3. Restore volumes (same mount points)
4. Set required env vars

### To Original
1. Switch back to original docker-compose
2. No data migration needed (compatible)

## Support

- **Issues**: File in EasyClaw repo
- **Original Project**: https://github.com/essamamdani/openclaw-coolify
- **Documentation**: See `WHAT_WE_KEEP.md` for detailed comparison
