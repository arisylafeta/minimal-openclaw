# What We're Keeping from the Original

## Core Architecture (CRITICAL - Must Keep)

### 1. Docker Proxy Security Pattern
**Why**: This is the security foundation that allows OpenClaw to spawn sandboxes safely
**Kept**: Same configuration with minimal API permissions
```yaml
docker-proxy:
  image: tecnativa/docker-socket-proxy:latest
  environment:
    POST: 1        # Create containers
    CONTAINERS: 1  # Manage containers
    IMAGES: 1      # Pull images
    NETWORKS: 1    # Network management
    INFO: 1        # System info
    VERSION: 1     # Version check
    EXEC: 1        # Execute commands in containers
```

### 2. Volume Persistence Model
**Why**: User data and workspaces must survive container restarts
**Kept**: 
- `openclaw-data` → /data (merged from openclaw-data + openclaw-config)
- `openclaw-workspace` → /data/openclaw-workspace

**Merged**: Combined the two config volumes into one for simplicity

### 3. Bootstrap Script Logic
**Why**: Handles initial setup, config generation, and token creation
**Kept**:
- Directory structure creation
- Config file generation (`openclaw.json`)
- Token generation for authentication
- Symlink setup for persistence

**Simplified**: Removed complex recovery and monitoring

### 4. OpenClaw Core Configuration
**Why**: These settings make OpenClaw work correctly
**Kept**:
- `DOCKER_HOST=tcp://docker-proxy:2375` - Security proxy connection
- `NODE_ENV=production` - Production mode
- `HOME=/data` - User home for persistence
- `OPENCLAW_STATE_DIR` - State storage location
- `OPENCLAW_WORKSPACE` - Project workspace
- `OPENCLAW_GATEWAY_PORT` - Port (now configurable)
- `OPENCLAW_GATEWAY_BIND=lan` - Bind to all interfaces
- `OPENCLAW_GATEWAY_TOKEN` - Authentication (generated by backend)
- `OPENCLAW_AUTO_BOOTSTRAP=1` - Auto-setup
- `OPENCLAW_PRINT_ACCESS=1` - Show access info on startup

### 5. Healthcheck Pattern
**Why**: Coolify needs to know when the service is ready
**Kept**: HTTP health check on the gateway port
**Updated**: Now uses configurable port from environment

### 6. Environment Variable Structure
**Why**: The backend injects these dynamically
**Kept**:
- `OPENAI_API_KEY` (or other AI provider)
- `TELEGRAM_BOT_TOKEN` (optional)
- `CONTAINER_ID` - Unique ID from backend
- `CONTAINER_NAME` - Container identifier
- `OPENCLAW_GATEWAY_TOKEN` - Auth token from backend
- `OPENCLAW_GATEWAY_PORT` - Port from backend PortAllocationService

## What's Changed (Simplified)

### 1. Dockerfile
**Original**: 5-stage multi-stage build with 50+ tools
**Minimal**: Single stage, essential tools only
- Kept: Node.js base, git, curl, jq, openssl
- Removed: Python, Go, Docker CLI, Cloudflared, GH CLI, Bun, Chromium, FFmpeg, AI CLIs

**Rationale**: OpenClaw sandboxes can install their own tools. The host just needs to run OpenClaw and spawn containers.

### 2. Services
**Original**: 4 services (openclaw, docker-proxy, searxng, registry)
**Minimal**: 2 services (openclaw, docker-proxy)
- Removed: SearXNG (search is optional)
- Removed: Registry (pull from Docker Hub)

**Rationale**: Core functionality is OpenClaw + sandboxing. Other services add features but aren't required.

### 3. Bootstrap Script
**Original**: 214 lines with recovery, monitoring, migration
**Minimal**: ~70 lines with basic setup
- Kept: Directory setup, config generation, token handling
- Removed: Recovery scripts, monitoring, sandbox setup (handled at runtime)

**Rationale**: Simpler is better. Sandboxes manage themselves.

### 4. Environment Variables
**Original**: 40+ variables
**Minimal**: ~15 variables
- Kept: Essential OpenClaw config, ONE AI provider, optional Telegram
- Removed: Multiple AI providers, deployment tools, optional integrations

**Rationale**: Start minimal, add back as needed.

## Critical Compatibility Requirements

### For EasyClaw Backend
1. **Port Configuration**: Must accept `OPENCLAW_GATEWAY_PORT` from backend
2. **Token Generation**: Must accept `OPENCLAW_GATEWAY_TOKEN` from backend
3. **Container Naming**: Must accept `CONTAINER_ID` and `CONTAINER_NAME`
4. **Volume Mounts**: Must persist to standard locations
5. **Healthcheck**: Must use configurable port

### For OpenClaw Runtime
1. **State Directory**: Must be at `OPENCLAW_STATE_DIR`
2. **Workspace**: Must be at `OPENCLAW_WORKSPACE`
3. **Docker Proxy**: Must connect to `tcp://docker-proxy:2375`
4. **Config Format**: Must generate valid `openclaw.json`

### For Sandboxes
1. **Image Pulling**: Must be able to pull from Docker Hub
2. **Container Creation**: Must work via docker-proxy
3. **Volume Mounts**: Must mount workspace correctly
4. **Networking**: Must connect to internal networks

## Testing Checklist

### Backend Integration
- [ ] Backend can set `OPENCLAW_GATEWAY_PORT` dynamically
- [ ] Backend can set `OPENCLAW_GATEWAY_TOKEN` dynamically
- [ ] Backend can read container logs for access URL
- [ ] Healthcheck passes on the allocated port

### OpenClaw Functionality
- [ ] Gateway starts on configured port
- [ ] Token authentication works
- [ ] Can spawn sandbox containers
- [ ] Workspace persists across restarts
- [ ] Telegram bot connects (if configured)

### Sandboxing
- [ ] Docker proxy allows container creation
- [ ] Sandboxes can pull images
- [ ] Sandboxes have network access
- [ ] Sandboxes can mount workspace volumes

## Migration Path from Original

### Data Compatibility
- Volume structure is compatible (data + workspace)
- Config format is the same (`openclaw.json`)
- Token generation works the same way

### Environment Variables
Most variables from the original will work, but only these are required:
```bash
OPENCLAW_GATEWAY_PORT=18789  # Or any port allocated by backend
OPENCLAW_GATEWAY_TOKEN=xxx   # Generated by backend
OPENAI_API_KEY=xxx           # Or other AI provider
```

### Missing Features (Add Back as Needed)
- [ ] Web search (add SearXNG service)
- [ ] Local registry (add registry service)
- [ ] Cloudflare tunnels (add cloudflared)
- [ ] Browser automation (add Chromium)
- [ ] Vercel deployment (add CLI in sandbox)
- [ ] GitHub CLI (add CLI in sandbox)
- [ ] Recovery scripts (add back if needed)
- [ ] Monitoring (add back if needed)

## File Comparison

| File | Original | Minimal | Status |
|------|----------|---------|--------|
| docker-compose.yaml | 142 lines | 73 lines | ✅ Simplified |
| Dockerfile | 153 lines, 5 stages | ~50 lines, 1 stage | ✅ Simplified |
| bootstrap.sh | 214 lines | ~70 lines | ✅ Simplified |
| .env.example | 45 lines | ~15 lines | ✅ Simplified |
| scripts/* | 7 scripts | 1 script | ✅ Simplified |
| services | 4 | 2 | ✅ Removed optional |
| volumes | 5 | 2 | ✅ Removed unused |

## Design Philosophy

The minimal version follows the Unix philosophy:
- **Do one thing well**: Run OpenClaw and spawn sandboxes
- **Everything is a file**: Volumes for persistence
- **Text interface**: Environment variables for configuration
- **Composable**: Can add services back as needed

This makes it:
- **Faster**: Smaller image, fewer services
- **Simpler**: Less to go wrong
- **Cheaper**: Lower resource usage
- **Flexible**: Add back what you need
